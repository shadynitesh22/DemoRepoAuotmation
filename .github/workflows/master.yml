name: Deploy to Remote Server

on:
  push:
    branches:
      - "*"

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: Server Access
    env:
      PEM_KEY: ${{ vars.PEM_KEY }}
    steps:
      # Checkout the source code
      - name: Checkout
        uses: actions/checkout@v2

      # Build the Docker Compose file
      # - name: Build Docker Compose
      #   run: |
      #     docker-compose build

      # Copy the Docker Compose file to server1
      - name: Copy Docker Compose file
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ vars.PEM_KEY }}
          port: 2020

          source: ./docker-compose.yml
          target: ./

 

      # Copy the Docker Compose file from jump server to remote server
      - name: Copy Docker Compose file to Remote server
       
        
        run: |
          echo "${{ vars.PEM_KEY }}" > pem_key.pem
          scp -o StrictHostKeyChecking=no -o ProxyJump=niteshp@jump.benekiva.io:2020 -i pem_key.pem /docker-compose.yml ubuntu@aedev.benekiva.io: /


      
      # SSH into remote server to deploy
      - name: Deploy using SSH
        uses: appleboy/ssh-action@master
        with:
          host: ubuntu@aedev.benekiva.io
          key: ${{ secrets.AKEY }}

          script: |

            sudo docker-compose build
            sudo docker network create automation        
            # docker-compose up
